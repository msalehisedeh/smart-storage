import * as tslib_1 from "tslib";
/*
* WizardStorage provides an easy way to use web storage capabilities of modern web browsers.
*
* reference to browser compatibilities.
* https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage#Browser_compatibility
* https://developer.mozilla.org/en-US/docs/Web/API/Window/sessionStorage#Browser_compatibility
*/
import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import * as i0 from "@angular/core";
var WizardStorageService = /** @class */ (function () {
    function WizardStorageService() {
        var _this = this;
        this.subjects = {
            local: {},
            session: {},
            cookies: {}
        };
        this.session = new Object();
        this.session.isSupported = function () { return _this.isSupported(sessionStorage); };
        this.session.onchange = function (key) { return _this.onChange(key, 'session'); };
        this.session.setItem = function (key, value, version, expires, isSecure) {
            _this.setItem('session', key, value, version, expires, isSecure);
        };
        this.session.getItem = function (key, options) { return _this.getItem('session', key, options); };
        this.session.hasItem = function (key) { return sessionStorage.getItem(key) !== null; };
        this.session.removeItem = function (key) {
            var oldV = _this.subjects.session[key] ? _this.session.getItem(key) : undefined;
            sessionStorage.removeItem(key);
            if (_this.subjects.session[key]) {
                _this.subjects.session[key].next({
                    key: key,
                    oldValue: oldV,
                    newValue: null,
                    url: document.location.href
                });
            }
        };
        this.session.getAllKeys = function () { return _this.getAllKeys(sessionStorage); };
        this.session.clear = function () { sessionStorage.clear(); };
        this.local = new Object();
        this.local.isSupported = function () { return _this.isSupported(localStorage); };
        this.local.onchange = function (key) { return _this.onChange(key, 'local'); };
        this.local.setItem = function (key, value, version, expires, isSecure) {
            _this.setItem('local', key, value, version, expires, isSecure);
        };
        this.local.getItem = function (key, options) { return _this.getItem('local', key, options); };
        this.local.hasItem = function (key) { return localStorage.getItem(key) !== null; };
        this.local.removeItem = function (key) {
            var oldV = _this.subjects.local[key] ? _this.local.getItem(key) : undefined;
            localStorage.removeItem(key);
            if (_this.subjects.local[key]) {
                _this.subjects.local[key].next({
                    key: key,
                    oldValue: oldV,
                    newValue: null,
                    url: document.location.href
                });
            }
        };
        this.local.getAllKeys = function () { return _this.getAllKeys(localStorage); };
        this.local.clear = function () { localStorage.clear(); };
        this.cookies = new Object();
        this.cookies.isSupported = function () { return true; };
        this.cookies.onchange = function (key) { return _this.onChange(key, 'cookies'); };
        this.cookies.setItem = function (key, value, expires, domain, path, isSecure) {
            if (!key || /^(?:expires|max\-age|path|domain|secure)$/i.test(key)) {
                return false;
            }
            var willExpires = "; expires=Fri, 31 Dec 9999 23:59:59 GMT";
            if (expires) {
                willExpires = "; max-age=" + (expires * 3600000);
            }
            var oldV = _this.cookies.getItem(key);
            var zVal = value;
            if (typeof value === 'object') {
                zVal = JSON.stringify(value);
            }
            document.cookie = encodeURIComponent(key) + "=" +
                encodeURIComponent(zVal) +
                willExpires + (domain ? "; domain=" + domain : "") +
                (path ? "; path=" + path : "") +
                (isSecure ? "; secure" : "");
            if (_this.subjects.cookies[key]) {
                _this.subjects.cookies[key].next({
                    key: key,
                    oldValue: oldV,
                    newValue: value,
                    url: document.location.href
                });
            }
            return true;
        };
        this.cookies.getItem = function (key) {
            var result = decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" +
                encodeURIComponent(key).replace(/[\-\.\+\*]/g, "\\$&") +
                "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
            return _this.toJson(result);
        };
        this.cookies.hasItem = function (key) {
            return (new RegExp("(?:^|;\\s*)" + encodeURIComponent(key).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=")).test(document.cookie);
        };
        this.cookies.removeItem = function (key, path, domain) {
            if (!key || !_this.cookies.hasItem(key)) {
                return false;
            }
            var oldV = _this.subjects.cookies[key] ? _this.cookies.getItem(key) : undefined;
            document.cookie = encodeURIComponent(key) +
                "=; expires=Thu, 01 Jan 1970 00:00:00 GMT" +
                (domain ? "; domain=" + domain : "") +
                (path ? "; path=" + path : "");
            if (_this.subjects.cookies[key]) {
                _this.subjects.cookies[key].next({
                    key: key,
                    oldValue: oldV,
                    newValue: null,
                    url: document.location.href
                });
            }
            return true;
        };
        this.cookies.getAllKeys = function () {
            var aKeys = document.cookie.replace(/((?:^|\s*;)[^\=]+)(?=;|$)|^\s*|\s*(?:\=[^;]*)?(?:\1|$)/g, "").split(/\s*(?:\=[^;]*)?;\s*/);
            for (var nIdx = 0; nIdx < aKeys.length; nIdx++) {
                aKeys[nIdx] = decodeURIComponent(aKeys[nIdx]);
            }
            return aKeys;
        };
        this.cookies.clear = function () {
            _this.cookies.getAllKeys().map(function (item) {
                _this.cookies.removeItem(item);
            });
        };
    }
    WizardStorageService.prototype.isSupported = function (storage) {
        try {
            var itemBackup = storage.getItem('');
            storage.removeItem('');
            storage.setItem('', itemBackup);
            if (itemBackup === null) {
                storage.removeItem('');
            }
            else {
                storage.setItem('', itemBackup);
            }
            return true;
        }
        catch (e) {
            return false;
        }
    };
    WizardStorageService.prototype.encode = function (value) {
        var x = JSON.stringify({ secured: value });
        return btoa(encodeURIComponent(x).split('').reverse().join(''));
    };
    WizardStorageService.prototype.decode = function (value) {
        var x = decodeURIComponent(atob(value).split('').reverse().join(''));
        return JSON.parse(x).secured;
    };
    WizardStorageService.prototype.getStorageItem = function (storage, key, options) {
        var result;
        try {
            result = storage.getItem(key);
            if (result) {
                result = JSON.parse(result);
                result.data = options.isSecure ? this.decode(result.data) : result.data;
            }
            else if (options && options.default) {
                var value = options.isSecure ? this.encode(options.default) : options.default;
                storage.setItem(key, JSON.stringify({ data: value }));
                result = { data: options.default };
            }
            else {
                result = { data: undefined };
            }
        }
        catch (e) {
            if (result && !result.data) {
                result = {
                    data: result
                };
            }
        }
        return result;
    };
    WizardStorageService.prototype.getItem = function (store, key, options) {
        var storage = store === 'session' ? sessionStorage : localStorage;
        var version = (typeof options === 'string') ? options : (options ? options.version : undefined);
        var content = this.getStorageItem(storage, key, options);
        var result;
        if (version && content.version) {
            if (version == content.version) {
                result = content.data;
            }
            else {
                result = undefined;
            }
        }
        else {
            result = content.data;
        }
        if (result && content.expires) {
            if (new Date().getTime() >= content.expires) {
                storage.removeItem(key);
                if (this.subjects[store][key]) {
                    this.subjects[store][key].next({
                        key: key,
                        oldValue: content,
                        newValue: null,
                        url: document.location.href
                    });
                }
                result = undefined;
            }
        }
        return result;
    };
    WizardStorageService.prototype.setItem = function (store, key, value, version, expires, isSecure) {
        var storage = store === 'session' ? sessionStorage : localStorage;
        var coded = isSecure ? this.encode(value) : value;
        var content = { data: coded };
        if (version) {
            content.version = version;
        }
        if (expires != undefined) {
            var d = new Date();
            d.setTime(d.getTime() + (expires * 3600000));
            content.expires = d.getTime();
        }
        var oldV = storage.getItem(key);
        try {
            storage.setItem(key, JSON.stringify(content));
            if (this.subjects[store][key]) {
                this.subjects[store][key].next({
                    key: key,
                    oldValue: oldV,
                    newValue: content,
                    url: document.location.href
                });
            }
        }
        catch (e) { }
    };
    WizardStorageService.prototype.getAllKeys = function (storage) {
        var result = [];
        try {
            for (var i = 0; i < storage.length; i++) {
                result.push(storage.key(i));
            }
        }
        catch (e) { }
        return result;
    };
    WizardStorageService.prototype.onChange = function (key, storage) {
        if (!this.subjects[storage][key]) {
            this.subjects[storage][key] = new BehaviorSubject(null);
        }
        return this.subjects[storage][key];
    };
    WizardStorageService.prototype.toJson = function (value) {
        var x = value;
        try {
            x = JSON.parse(value);
        }
        catch (e) { }
        return x;
    };
    WizardStorageService.ngInjectableDef = i0.ɵɵdefineInjectable({ factory: function WizardStorageService_Factory() { return new WizardStorageService(); }, token: WizardStorageService, providedIn: "root" });
    WizardStorageService = tslib_1.__decorate([
        Injectable({
            providedIn: 'root'
        })
    ], WizardStorageService);
    return WizardStorageService;
}());
export { WizardStorageService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2l6YXJkLXN0b3JhZ2Uuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BzZWRlaC93aXphcmQtc3RvcmFnZS8iLCJzb3VyY2VzIjpbInNyYy9hcHAvd2l6YXJkLXN0b3JhZ2Uvd2l6YXJkLXN0b3JhZ2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0E7Ozs7OztFQU1FO0FBQ0YsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUN6QyxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sTUFBTSxDQUFDOztBQUtyQztJQW9JSTtRQUFBLGlCQTZIQztRQTNQTyxhQUFRLEdBQUc7WUFDZixLQUFLLEVBQUUsRUFBRTtZQUNULE9BQU8sRUFBRSxFQUFFO1lBQ1gsT0FBTyxFQUFFLEVBQUU7U0FDZCxDQUFDO1FBNEhFLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUM1QixJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsR0FBRyxjQUFPLE9BQU8sS0FBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsQ0FBQSxDQUFBLENBQUMsQ0FBQztRQUMzRSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsR0FBRyxVQUFDLEdBQVcsSUFBTSxPQUFPLEtBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQyxDQUFBLENBQUEsQ0FBQyxDQUFBO1FBQy9FLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLFVBQUMsR0FBVyxFQUFFLEtBQVUsRUFBRSxPQUFnQixFQUFFLE9BQWdCLEVBQUUsUUFBa0I7WUFDbkcsS0FBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3BFLENBQUMsQ0FBQztRQUNGLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxHQUFHLFVBQUMsR0FBVyxFQUFFLE9BQWEsSUFBTSxP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QUMsQ0FBQztTQUN6QjtRQUFBLE9BQU0sQ0FBQyxFQUFDLEdBQUU7UUFDWCxPQUFPLENBQUMsQ0FBQztJQUNiLENBQUM7O0lBelFRLG9CQUFvQjtRQUhoQyxVQUFVLENBQUM7WUFDUixVQUFVLEVBQUUsTUFBTTtTQUNyQixDQUFDO09BQ1csb0JBQW9CLENBMFFoQzsrQkF4UkQ7Q0F3UkMsQUExUUQsSUEwUUM7U0ExUVksb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbi8qXHJcbiogV2l6YXJkU3RvcmFnZSBwcm92aWRlcyBhbiBlYXN5IHdheSB0byB1c2Ugd2ViIHN0b3JhZ2UgY2FwYWJpbGl0aWVzIG9mIG1vZGVybiB3ZWIgYnJvd3NlcnMuXHJcbipcclxuKiByZWZlcmVuY2UgdG8gYnJvd3NlciBjb21wYXRpYmlsaXRpZXMuXHJcbiogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dpbmRvdy9sb2NhbFN0b3JhZ2UjQnJvd3Nlcl9jb21wYXRpYmlsaXR5XHJcbiogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1dpbmRvdy9zZXNzaW9uU3RvcmFnZSNCcm93c2VyX2NvbXBhdGliaWxpdHlcclxuKi9cclxuaW1wb3J0IHtJbmplY3RhYmxlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtCZWhhdmlvclN1YmplY3R9IGZyb20gJ3J4anMnO1xyXG5cclxuQEluamVjdGFibGUoe1xyXG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBXaXphcmRTdG9yYWdlU2VydmljZSB7XHJcblxyXG4gICAgcHVibGljIGxvY2FsOiBhbnk7XHJcbiAgICBwdWJsaWMgc2Vzc2lvbjogYW55O1xyXG4gICAgcHVibGljIGNvb2tpZXM6IGFueTtcclxuXHJcbiAgICBwcml2YXRlIHN1YmplY3RzID0ge1xyXG4gICAgICAgIGxvY2FsOiB7fSxcclxuICAgICAgICBzZXNzaW9uOiB7fSxcclxuICAgICAgICBjb29raWVzOiB7fVxyXG4gICAgfTtcclxuXHJcbiAgICBwcml2YXRlIGlzU3VwcG9ydGVkKHN0b3JhZ2U6IGFueSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW1CYWNrdXAgPSBzdG9yYWdlLmdldEl0ZW0oJycpO1xyXG4gICAgICAgICAgICBzdG9yYWdlLnJlbW92ZUl0ZW0oJycpO1xyXG4gICAgICAgICAgICBzdG9yYWdlLnNldEl0ZW0oJycsIGl0ZW1CYWNrdXApO1xyXG4gICAgICAgICAgICBpZiAoaXRlbUJhY2t1cCA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgc3RvcmFnZS5yZW1vdmVJdGVtKCcnKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHN0b3JhZ2Uuc2V0SXRlbSgnJywgaXRlbUJhY2t1cCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGVuY29kZSh2YWx1ZTogc3RyaW5nKTogYW55IHtcclxuICAgICAgICBjb25zdCB4ID0gSlNPTi5zdHJpbmdpZnkoe3NlY3VyZWQ6IHZhbHVlfSk7XHJcbiAgICAgICAgcmV0dXJuIGJ0b2EoZW5jb2RlVVJJQ29tcG9uZW50KHgpLnNwbGl0KCcnKS5yZXZlcnNlKCkuam9pbignJykpO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBkZWNvZGUodmFsdWU6IHN0cmluZyk6IGFueSB7XHJcbiAgICAgICAgY29uc3QgeCA9IGRlY29kZVVSSUNvbXBvbmVudChhdG9iKHZhbHVlKS5zcGxpdCgnJykucmV2ZXJzZSgpLmpvaW4oJycpKTtcclxuICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh4KS5zZWN1cmVkO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBnZXRTdG9yYWdlSXRlbShzdG9yYWdlOiBhbnksIGtleTogc3RyaW5nLCBvcHRpb25zPzogYW55KSB7XHJcbiAgICAgICAgbGV0IHJlc3VsdDogYW55O1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHJlc3VsdCA9IHN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBKU09OLnBhcnNlKHJlc3VsdCk7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQuZGF0YSA9IG9wdGlvbnMuaXNTZWN1cmUgPyB0aGlzLmRlY29kZShyZXN1bHQuZGF0YSkgOiByZXN1bHQuZGF0YVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5kZWZhdWx0KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG9wdGlvbnMuaXNTZWN1cmUgPyB0aGlzLmVuY29kZShvcHRpb25zLmRlZmF1bHQpIDogb3B0aW9ucy5kZWZhdWx0O1xyXG4gICAgICAgICAgICAgICAgc3RvcmFnZS5zZXRJdGVtKGtleSwgSlNPTi5zdHJpbmdpZnkoe2RhdGE6IHZhbHVlfSkpO1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0ge2RhdGE6IG9wdGlvbnMuZGVmYXVsdH07XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSB7ZGF0YTogdW5kZWZpbmVkfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2goZSkge1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0ICYmICFyZXN1bHQuZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0ge1xyXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHJlc3VsdFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBnZXRJdGVtKHN0b3JlOiBzdHJpbmcsIGtleTogc3RyaW5nLCBvcHRpb25zPzogYW55KSB7XHJcbiAgICAgICAgY29uc3Qgc3RvcmFnZTogYW55ID0gc3RvcmUgPT09ICdzZXNzaW9uJyA/IHNlc3Npb25TdG9yYWdlIDogbG9jYWxTdG9yYWdlXHJcbiAgICAgICAgY29uc3QgdmVyc2lvbiA9ICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ3N0cmluZycpID8gb3B0aW9ucyA6IChvcHRpb25zID8gb3B0aW9ucy52ZXJzaW9uIDogdW5kZWZpbmVkKTtcclxuICAgICAgICBsZXQgY29udGVudDogYW55ID0gdGhpcy5nZXRTdG9yYWdlSXRlbShzdG9yYWdlLCBrZXksIG9wdGlvbnMpO1xyXG4gICAgICAgIGxldCByZXN1bHQ6IGFueTtcclxuXHJcbiAgICAgICAgaWYgKHZlcnNpb24gJiYgY29udGVudC52ZXJzaW9uKSB7XHJcbiAgICAgICAgICAgIGlmICh2ZXJzaW9uID09IGNvbnRlbnQudmVyc2lvbikge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gY29udGVudC5kYXRhO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzdWx0ID0gY29udGVudC5kYXRhO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocmVzdWx0ICYmIGNvbnRlbnQuZXhwaXJlcykge1xyXG4gICAgICAgICAgICBpZiAobmV3IERhdGUoKS5nZXRUaW1lKCkgPj0gY29udGVudC5leHBpcmVzKSB7XHJcbiAgICAgICAgICAgICAgICBzdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLnN1YmplY3RzW3N0b3JlXVtrZXldKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdWJqZWN0c1tzdG9yZV1ba2V5XS5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlOiBjb250ZW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZTogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXN1bHQgPSB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIHByaXZhdGUgc2V0SXRlbShzdG9yZTogc3RyaW5nLCBrZXk6IHN0cmluZywgdmFsdWU6IGFueSwgdmVyc2lvbj86IHN0cmluZywgZXhwaXJlcz86IG51bWJlciwgaXNTZWN1cmU/OiBib29sZWFuKSB7XHJcbiAgICAgICAgY29uc3Qgc3RvcmFnZTogYW55ID0gc3RvcmUgPT09ICdzZXNzaW9uJyA/IHNlc3Npb25TdG9yYWdlIDogbG9jYWxTdG9yYWdlO1xyXG4gICAgICAgIGNvbnN0IGNvZGVkID0gaXNTZWN1cmUgPyB0aGlzLmVuY29kZSh2YWx1ZSkgOiB2YWx1ZTtcclxuICAgICAgICBjb25zdCBjb250ZW50OiBhbnkgPSB7ZGF0YTogY29kZWR9O1xyXG5cclxuICAgICAgICBpZiAodmVyc2lvbikge1xyXG4gICAgICAgICAgICBjb250ZW50LnZlcnNpb24gPSB2ZXJzaW9uO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoZXhwaXJlcyAhPSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgY29uc3QgZCA9IG5ldyBEYXRlKCk7XHJcbiAgICAgICAgICAgIGQuc2V0VGltZShkLmdldFRpbWUoKSArIChleHBpcmVzKjM2MDAwMDApKTsgXHJcbiAgICAgICAgICAgIGNvbnRlbnQuZXhwaXJlcyA9IGQuZ2V0VGltZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBvbGRWID0gc3RvcmFnZS5nZXRJdGVtKGtleSk7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgc3RvcmFnZS5zZXRJdGVtKGtleSwgSlNPTi5zdHJpbmdpZnkoY29udGVudCkpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zdWJqZWN0c1tzdG9yZV1ba2V5XSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJqZWN0c1tzdG9yZV1ba2V5XS5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSxcclxuICAgICAgICAgICAgICAgICAgICBvbGRWYWx1ZTogb2xkVixcclxuICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZTogY29udGVudCxcclxuICAgICAgICAgICAgICAgICAgICB1cmw6IGRvY3VtZW50LmxvY2F0aW9uLmhyZWZcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaChlKXt9XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGdldEFsbEtleXMoc3RvcmFnZTogYW55KSB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gW107XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHN0b3JhZ2UubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKHN0b3JhZ2Uua2V5KCBpICkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBjYXRjaChlKXt9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuICAgIHByaXZhdGUgb25DaGFuZ2Uoa2V5OiBzdHJpbmcsIHN0b3JhZ2U6IHN0cmluZykge1xyXG4gICAgICAgIGlmICghdGhpcy5zdWJqZWN0c1tzdG9yYWdlXVtrZXldKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc3ViamVjdHNbc3RvcmFnZV1ba2V5XSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8YW55PihudWxsKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuc3ViamVjdHNbc3RvcmFnZV1ba2V5XTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuXHJcbiAgICAgICAgdGhpcy5zZXNzaW9uID0gbmV3IE9iamVjdCgpO1xyXG4gICAgICAgIHRoaXMuc2Vzc2lvbi5pc1N1cHBvcnRlZCA9ICgpID0+IHtyZXR1cm4gdGhpcy5pc1N1cHBvcnRlZChzZXNzaW9uU3RvcmFnZSl9O1xyXG4gICAgICAgIHRoaXMuc2Vzc2lvbi5vbmNoYW5nZSA9IChrZXk6IHN0cmluZykgPT4ge3JldHVybiB0aGlzLm9uQ2hhbmdlKGtleSwgJ3Nlc3Npb24nKX1cclxuICAgICAgICB0aGlzLnNlc3Npb24uc2V0SXRlbSA9IChrZXk6IHN0cmluZywgdmFsdWU6IGFueSwgdmVyc2lvbj86IHN0cmluZywgZXhwaXJlcz86IG51bWJlciwgaXNTZWN1cmU/OiBib29sZWFuKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0SXRlbSgnc2Vzc2lvbicsIGtleSwgdmFsdWUsIHZlcnNpb24sIGV4cGlyZXMsIGlzU2VjdXJlKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuc2Vzc2lvbi5nZXRJdGVtID0gKGtleTogc3RyaW5nLCBvcHRpb25zPzogYW55KSA9PiB7cmV0dXJuIHRoaXMuZ2V0SXRlbSgnc2Vzc2lvbicsIGtleSwgb3B0aW9ucyl9O1xyXG4gICAgICAgIHRoaXMuc2Vzc2lvbi5oYXNJdGVtID0gKGtleTogc3RyaW5nKSA9PiB7cmV0dXJuIHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oa2V5KSAhPT0gbnVsbH07XHJcbiAgICAgICAgdGhpcy5zZXNzaW9uLnJlbW92ZUl0ZW0gPSAoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgb2xkViA9IHRoaXMuc3ViamVjdHMuc2Vzc2lvbltrZXldID8gdGhpcy5zZXNzaW9uLmdldEl0ZW0oa2V5KTogdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnN1YmplY3RzLnNlc3Npb25ba2V5XSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJqZWN0cy5zZXNzaW9uW2tleV0ubmV4dCh7XHJcbiAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksXHJcbiAgICAgICAgICAgICAgICAgICAgb2xkVmFsdWU6IG9sZFYsXHJcbiAgICAgICAgICAgICAgICAgICAgbmV3VmFsdWU6IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5zZXNzaW9uLmdldEFsbEtleXMgPSAoKSA9PiB7cmV0dXJuIHRoaXMuZ2V0QWxsS2V5cyhzZXNzaW9uU3RvcmFnZSl9O1xyXG4gICAgICAgIHRoaXMuc2Vzc2lvbi5jbGVhciA9ICgpID0+IHsgc2Vzc2lvblN0b3JhZ2UuY2xlYXIoKX07XHJcblxyXG4gICAgICAgIFxyXG4gICAgICAgIHRoaXMubG9jYWwgPSBuZXcgT2JqZWN0KCk7XHJcbiAgICAgICAgdGhpcy5sb2NhbC5pc1N1cHBvcnRlZCA9ICgpID0+IHtyZXR1cm4gdGhpcy5pc1N1cHBvcnRlZChsb2NhbFN0b3JhZ2UpfTtcclxuICAgICAgICB0aGlzLmxvY2FsLm9uY2hhbmdlID0gKGtleTogc3RyaW5nKSA9PiB7cmV0dXJuIHRoaXMub25DaGFuZ2Uoa2V5LCAnbG9jYWwnKX1cclxuICAgICAgICB0aGlzLmxvY2FsLnNldEl0ZW0gPSAoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnksIHZlcnNpb24/OiBzdHJpbmcsIGV4cGlyZXM/OiBudW1iZXIsIGlzU2VjdXJlPzogYm9vbGVhbikgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnNldEl0ZW0oJ2xvY2FsJywga2V5LCB2YWx1ZSx2ZXJzaW9uLCBleHBpcmVzLCBpc1NlY3VyZSk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmxvY2FsLmdldEl0ZW0gPSAoa2V5OiBzdHJpbmcsIG9wdGlvbnM/OiBhbnkpID0+IHtyZXR1cm4gdGhpcy5nZXRJdGVtKCdsb2NhbCcsIGtleSwgb3B0aW9ucyl9O1xyXG4gICAgICAgIHRoaXMubG9jYWwuaGFzSXRlbSA9IChrZXk6IHN0cmluZykgPT4ge3JldHVybiBsb2NhbFN0b3JhZ2UuZ2V0SXRlbShrZXkpICE9PSBudWxsfTtcclxuICAgICAgICB0aGlzLmxvY2FsLnJlbW92ZUl0ZW0gPSAoa2V5OiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgY29uc3Qgb2xkViA9IHRoaXMuc3ViamVjdHMubG9jYWxba2V5XSA/IHRoaXMubG9jYWwuZ2V0SXRlbShrZXkpOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSlcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3ViamVjdHMubG9jYWxba2V5XSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zdWJqZWN0cy5sb2NhbFtrZXldLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgICAgIGtleToga2V5LFxyXG4gICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlOiBvbGRWLFxyXG4gICAgICAgICAgICAgICAgICAgIG5ld1ZhbHVlOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIHVybDogZG9jdW1lbnQubG9jYXRpb24uaHJlZlxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMubG9jYWwuZ2V0QWxsS2V5cyA9ICgpID0+IHtyZXR1cm4gdGhpcy5nZXRBbGxLZXlzKGxvY2FsU3RvcmFnZSl9O1xyXG4gICAgICAgIHRoaXMubG9jYWwuY2xlYXIgPSAoKSA9PiB7bG9jYWxTdG9yYWdlLmNsZWFyKCl9O1xyXG5cclxuICAgICAgICB0aGlzLmNvb2tpZXMgPSAgbmV3IE9iamVjdCgpO1xyXG4gICAgICAgIHRoaXMuY29va2llcy5pc1N1cHBvcnRlZCA9ICgpID0+IHtyZXR1cm4gdHJ1ZTt9O1xyXG4gICAgICAgIHRoaXMuY29va2llcy5vbmNoYW5nZSA9IChrZXk6IHN0cmluZykgPT4ge3JldHVybiB0aGlzLm9uQ2hhbmdlKGtleSwgJ2Nvb2tpZXMnKX1cclxuICAgICAgICB0aGlzLmNvb2tpZXMuc2V0SXRlbSA9IChrZXk6IHN0cmluZywgdmFsdWU6IGFueSwgZXhwaXJlcz86IG51bWJlciwgZG9tYWluPzogc3RyaW5nLCBwYXRoPzogc3RyaW5nLCBpc1NlY3VyZT86IGJvb2xlYW4pID0+IHtcclxuICAgICAgICAgICAgaWYgKCFrZXkgfHwgL14oPzpleHBpcmVzfG1heFxcLWFnZXxwYXRofGRvbWFpbnxzZWN1cmUpJC9pLnRlc3Qoa2V5KSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCB3aWxsRXhwaXJlcyA9IFwiOyBleHBpcmVzPUZyaSwgMzEgRGVjIDk5OTkgMjM6NTk6NTkgR01UXCI7XHJcbiAgICAgICAgICAgIGlmIChleHBpcmVzKSB7XHJcbiAgICAgICAgICAgICAgICB3aWxsRXhwaXJlcyA9IFwiOyBtYXgtYWdlPVwiICsgKGV4cGlyZXMqMzYwMDAwMCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY29uc3Qgb2xkViA9IHRoaXMuY29va2llcy5nZXRJdGVtKGtleSk7XHJcbiAgICAgICAgICAgIGxldCB6VmFsID0gdmFsdWU7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKXtcclxuICAgICAgICAgICAgICAgIHpWYWwgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZG9jdW1lbnQuY29va2llID0gZW5jb2RlVVJJQ29tcG9uZW50KGtleSkgKyBcIj1cIiArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVuY29kZVVSSUNvbXBvbmVudCh6VmFsKSArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbGxFeHBpcmVzICsgKGRvbWFpbiA/IFwiOyBkb21haW49XCIgKyBkb21haW4gOiBcIlwiKSArXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChwYXRoID8gXCI7IHBhdGg9XCIgKyBwYXRoIDogXCJcIikgK1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoaXNTZWN1cmUgPyBcIjsgc2VjdXJlXCIgOiBcIlwiKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuc3ViamVjdHMuY29va2llc1trZXldKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnN1YmplY3RzLmNvb2tpZXNba2V5XS5uZXh0KHtcclxuICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSxcclxuICAgICAgICAgICAgICAgICAgICBvbGRWYWx1ZTogb2xkVixcclxuICAgICAgICAgICAgICAgICAgICBuZXdWYWx1ZTogdmFsdWUsXHJcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBkb2N1bWVudC5sb2NhdGlvbi5ocmVmXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuY29va2llcy5nZXRJdGVtID0gKGtleTogc3RyaW5nKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGRlY29kZVVSSUNvbXBvbmVudChcclxuICAgICAgICAgICAgICAgIGRvY3VtZW50LmNvb2tpZS5yZXBsYWNlKG5ldyBSZWdFeHAoXCIoPzooPzpefC4qOylcXFxccypcIiArXHJcbiAgICAgICAgICAgICAgICBlbmNvZGVVUklDb21wb25lbnQoa2V5KS5yZXBsYWNlKC9bXFwtXFwuXFwrXFwqXS9nLCBcIlxcXFwkJlwiKSArXHJcbiAgICAgICAgICAgICAgICBcIlxcXFxzKlxcXFw9XFxcXHMqKFteO10qKS4qJCl8Xi4qJFwiKSwgXCIkMVwiKSkgfHwgbnVsbDtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMudG9Kc29uKHJlc3VsdCk7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNvb2tpZXMuaGFzSXRlbSA9IChrZXk6IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gKFxyXG4gICAgICAgICAgICAgICAgbmV3IFJlZ0V4cChcIig/Ol58O1xcXFxzKilcIiArIGVuY29kZVVSSUNvbXBvbmVudChrZXkpLnJlcGxhY2UoL1tcXC1cXC5cXCtcXCpdL2csIFwiXFxcXCQmXCIpICsgXCJcXFxccypcXFxcPVwiKVxyXG4gICAgICAgICAgICApLnRlc3QoZG9jdW1lbnQuY29va2llKTtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuY29va2llcy5yZW1vdmVJdGVtID0gKGtleTogc3RyaW5nLCBwYXRoPzogc3RyaW5nLCBkb21haW4/OiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgaWYgKCFrZXkgfHwgIXRoaXMuY29va2llcy5oYXNJdGVtKGtleSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBvbGRWID0gdGhpcy5zdWJqZWN0cy5jb29raWVzW2tleV0gPyB0aGlzLmNvb2tpZXMuZ2V0SXRlbShrZXkpOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IGVuY29kZVVSSUNvbXBvbmVudChrZXkpICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiPTsgZXhwaXJlcz1UaHUsIDAxIEphbiAxOTcwIDAwOjAwOjAwIEdNVFwiICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICggZG9tYWluID8gXCI7IGRvbWFpbj1cIiArIGRvbWFpbiA6IFwiXCIpICtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICggcGF0aCA/IFwiOyBwYXRoPVwiICsgcGF0aCA6IFwiXCIpO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5zdWJqZWN0cy5jb29raWVzW2tleV0pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc3ViamVjdHMuY29va2llc1trZXldLm5leHQoe1xyXG4gICAgICAgICAgICAgICAgICAgIGtleToga2V5LFxyXG4gICAgICAgICAgICAgICAgICAgIG9sZFZhbHVlOiBvbGRWLFxyXG4gICAgICAgICAgICAgICAgICAgIG5ld1ZhbHVlOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIHVybDogZG9jdW1lbnQubG9jYXRpb24uaHJlZlxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLmNvb2tpZXMuZ2V0QWxsS2V5cyA9ICgpID0+IHtcclxuICAgICAgICAgICAgdmFyIGFLZXlzID0gZG9jdW1lbnQuY29va2llLnJlcGxhY2UoLygoPzpefFxccyo7KVteXFw9XSspKD89O3wkKXxeXFxzKnxcXHMqKD86XFw9W147XSopPyg/OlxcMXwkKS9nLCBcIlwiKS5zcGxpdCgvXFxzKig/OlxcPVteO10qKT87XFxzKi8pO1xyXG4gICAgICAgICAgICBmb3IgKHZhciBuSWR4ID0gMDsgbklkeCA8IGFLZXlzLmxlbmd0aDsgbklkeCsrKSB7XHJcbiAgICAgICAgICAgICAgICBhS2V5c1tuSWR4XSA9IGRlY29kZVVSSUNvbXBvbmVudChhS2V5c1tuSWR4XSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGFLZXlzO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5jb29raWVzLmNsZWFyID0gKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNvb2tpZXMuZ2V0QWxsS2V5cygpLm1hcChcclxuICAgICAgICAgICAgICAgIChpdGVtOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvb2tpZXMucmVtb3ZlSXRlbShpdGVtKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdG9Kc29uKHZhbHVlOiBhbnkpIHtcclxuICAgICAgICBsZXQgeCA9IHZhbHVlO1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIHggPSBKU09OLnBhcnNlKHZhbHVlKTtcclxuICAgICAgICB9Y2F0Y2goZSl7fVxyXG4gICAgICAgIHJldHVybiB4O1xyXG4gICAgfVxyXG59XHJcbiJdfQ==